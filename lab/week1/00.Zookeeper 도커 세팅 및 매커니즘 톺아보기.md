# Zookeeper 도커 세팅 및 매커니즘 톺아보기

Zookeeper는 Kafka, Hadoop, HBase 등의 분산 시스템에서 coordination service 역할을 수행한다.  
직접 데이터를 저장하지 않고, 노드의 상태와 구성을 추적하거나 분산 락, watch 등의 기능을 제공하는 것이 핵심이다.

---

## 1. docker-compose.yml 구성

```yaml
version: '3'
services:
  zookeeper:
    image: zookeeper:3.5.9
    container_name: zookeeper
    ports:
      - "2181:2181"
    environment:
      ZOO_CLIENT_PORT: 2181
```

### 각각의 항목에 대해서

- `version`: Docker Compose 구성 파일 버전
- `services`: 여러 컨테이너 정의를 위한 블록
- `zookeeper`: 서비스 이름
- `image`: 사용할 Zookeeper 이미지
- `container_name`: 컨테이너 이름 지정
- `ports`: 호스트와 컨테이너 간 포트 매핑
- `environment`: 내부 설정 전달. `ZOO_CLIENT_PORT`는 반드시 설정해야 함. 미설정 시 포트 바인딩 실패

---

## 2. 도커 실행 및 접속 흐름

### 2-1. 실행

```bash

docker-compose up -d
```

Zookeeper는 Java 기반 서버로 실행되며, 내부적으로 `/conf/zoo.cfg` 설정을 사용한다.

### 2-2. 컨테이너 상태 및 로그 확인

```bash

docker ps -a | grep zookeeper
docker logs -f zookeeper
```

정상 로그

```
binding to port /0.0.0.0:2181
Started AdminServer on address 0.0.0.0, port 8080
```

`clientPort is not set` 로그가 출력되면 `ZOO_CLIENT_PORT` 설정 누락이다.

---

## 3. Zookeeper CLI 접속

```bash

docker exec -it zookeeper zkCli.sh -server 127.0.0.1:2181
```

- `zkCli.sh`는 Zookeeper에 TCP 기반으로 연결해 ZNode 조작을 수행하는 CLI 도구이다.
- 내부적으로 `ZooKeeper.connect()`를 통해 TCP 세션을 생성한다.

---

## 4. 노드 테스트 명령어

```bash

create /hello "world"
get /hello
set /hello "newworld"
get /hello
delete /hello
```

---

## 5. 내부 동작 원리 및 개념 정리

### ZNode란?

- Zookeeper 의 데이터 단위
- 계층형 구조로 구성 되어있다 (트리 구조)
- 각각의 ZNode는 다음 정보를 가진다:
    - 이름 (e.g : `/hello`)
    - 데이터 (`byte[]`)
    - 자식 노드 목록
    - 상태 정보 (`stat`)

### ZNode의 종류

| 타입 | 설명                                               |
|------|--------------------------------------------------|
| Persistent | 기본 노드. 세션 종료와 무관하게 유지된다                          |
| Ephemeral | 세션이 종료되면 자동으로 삭제된다                               |
| Sequential | 생성 시 고유 번호가 자동으로 부여된다 (예를 들어, `/lock-000000001`) |

### 트리구조 인 이유

- ZNode 간의 관계를 명확히 표현할 수 있다.
- Watch 기능을 통한 변경 감지가 용이하다.
- 분산 락 구현 시, 순서성과 위계를 표현할 수 있다.

---

## 6. Watch란?

- ZNode에 대한 변경 감지를 위한 1회성 트리거 이다.
- CLI에서 사용 해보자

```bash

get /hello watch
```

- 해당 노드가 변경되면 Watcher에 이벤트가 전달된다.
- 재등록이 필요하며, Kafka/etcd 등에서 내부적으로 적극 활용된다.

---

## 7. 정리

| 개념 | 설명 |
|------|------|
| ZNode | Zookeeper의 핵심 데이터 단위 |
| Persistent | 삭제하지 않는 한 유지됨 |
| Ephemeral | 세션 종료 시 삭제됨 |
| Sequential | 자동 번호 부여 |
| zkCli.sh | CLI 기반의 Zookeeper 조작 도구 |
| ZooKeeper.connect() | 세션을 생성하고 TCP 연결을 맺는 메서드 |
| Watch | ZNode 변경 감지 기능 (1회성) |

---

# Zookeeper Ephemeral & Sequential Node 실습

Zookeeper는 세션 기반 노드 관리 기능을 통해, 분산 환경에서 임시 데이터 관리나 분산 락 구현이 가능하다.  
ephemeral 및 sequential ZNode의 개념과 실습 절차를 톺아보자.

---

